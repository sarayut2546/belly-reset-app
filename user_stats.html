<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สถิติสุขภาพ - Belly Reset</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
  <script src="firebaseConfig.js"></script>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Kanit', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px 20px;
    }

    .container-custom {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .page-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 35px 45px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      animation: fadeInDown 0.6s ease-out;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page-header h1 {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 10px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .page-header p {
      color: #666;
      margin: 0;
      font-size: 15px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      animation: fadeIn 0.6s ease-out 0.2s both;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .stat-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
    }

    .stat-unit {
      font-size: 14px;
      color: #9ca3af;
      margin-top: 5px;
    }

    /* Chart Section */
    .chart-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 35px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      animation: fadeIn 0.6s ease-out 0.4s both;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f3f4f6;
    }

    .chart-title {
      font-size: 22px;
      font-weight: 700;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-title i {
      color: #667eea;
    }

    /* Loading & Empty States */
    .loading-state, .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .loading-state i {
      font-size: 48px;
      margin-bottom: 15px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 20px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .empty-state p {
      font-size: 14px;
      color: #9ca3af;
    }

    /* Buttons */
    .btn-back {
      background: rgba(255, 255, 255, 0.95);
      border: none;
      padding: 12px 28px;
      border-radius: 12px;
      color: #667eea;
      font-weight: 600;
      transition: all 0.3s;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-decoration: none;
    }

    .btn-back:hover {
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      color: #667eea;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 20px 15px;
      }

      .page-header {
        padding: 25px 30px;
      }

      .page-header h1 {
        font-size: 28px;
      }

      .chart-section {
        padding: 25px 20px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container-custom">
    <div class="page-header">
      <h1><i class="bi bi-graph-up-arrow"></i> สถิติสุขภาพของคุณ</h1>
      <p>ติดตามและวิเคราะห์ความก้าวหน้าสุขภาพของคุณ</p>
    </div>

    <!-- Stats Cards -->
    <div id="statsCards" class="stats-grid">
      <div class="stat-card">
        <div class="loading-state">
          <i class="bi bi-arrow-repeat"></i>
          <p>กำลังโหลด...</p>
        </div>
      </div>
    </div>

    <!-- Weight Chart -->
    <div class="chart-section" id="weightChartSection" style="display: none;">
      <div class="chart-header">
        <div class="chart-title">
          <i class="bi bi-graph-up"></i>
          กราฟน้ำหนัก
        </div>
        <span style="color: #6b7280; font-size: 14px;">7 วันล่าสุด</span>
      </div>
      <canvas id="weightChart"></canvas>
    </div>

    <!-- Calorie Chart -->
    <div class="chart-section" id="calorieChartSection" style="display: none;">
      <div class="chart-header">
        <div class="chart-title">
          <i class="bi bi-fire"></i>
          กราฟแคลอรี่
        </div>
        <span style="color: #6b7280; font-size: 14px;">7 วันล่าสุด</span>
      </div>
      <canvas id="calorieChart"></canvas>
    </div>

    <div class="text-center mt-4">
      <a href="user_dashboard.html" class="btn-back">
        <i class="bi bi-arrow-left-circle"></i> กลับหน้าหลัก
      </a>
    </div>
  </div>

  <script>
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const userId = sessionStorage.getItem("userId");
    const userRole = sessionStorage.getItem("userRole");

    if (!userId) {
      alert("กรุณาเข้าสู่ระบบก่อนใช้งาน");
      window.location.href = "login.html";
    }

    let weightChart = null;
    let calorieChart = null;

    async function loadUserStats() {
      const statsCards = document.getElementById("statsCards");
      
      try {
        // โหลดข้อมูลผู้ใช้จาก users collection
        const userDoc = await db.collection("users").doc(userId).get();
        
        if (!userDoc.exists) {
          statsCards.innerHTML = `
            <div class="stat-card" style="grid-column: 1 / -1;">
              <div class="empty-state">
                <i class="bi bi-person-x"></i>
                <h3>ไม่พบข้อมูลผู้ใช้</h3>
                <p>กรุณาติดต่อผู้ดูแลระบบ</p>
              </div>
            </div>
          `;
          return;
        }

        const userData = userDoc.data();
        
        // คำนวณ BMI
        let bmi = 0;
        if (userData.weight && userData.height) {
          const heightInMeters = userData.height / 100;
          bmi = userData.weight / (heightInMeters * heightInMeters);
        }

        // แสดง Stats Cards
        statsCards.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">น้ำหนัก</div>
            <div class="stat-value">${userData.weight || 0}</div>
            <div class="stat-unit">กิโลกรัม</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ส่วนสูง</div>
            <div class="stat-value">${userData.height || 0}</div>
            <div class="stat-unit">เซนติเมตร</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">BMI</div>
            <div class="stat-value">${bmi > 0 ? bmi.toFixed(1) : '0'}</div>
            <div class="stat-unit">${getBMIStatus(bmi)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">อายุ</div>
            <div class="stat-value">${userData.age || 0}</div>
            <div class="stat-unit">ปี</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">BMR</div>
            <div class="stat-value">${userData.bmr ? userData.bmr.toFixed(0) : '0'}</div>
            <div class="stat-unit">แคลอรี่/วัน</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">TDEE</div>
            <div class="stat-value">${userData.tdee ? userData.tdee.toFixed(0) : '0'}</div>
            <div class="stat-unit">แคลอรี่/วัน</div>
          </div>
        `;

        // โหลดข้อมูลกราฟ
        await loadChartData();

      } catch (error) {
        console.error("Error loading stats:", error);
        statsCards.innerHTML = `
          <div class="stat-card" style="grid-column: 1 / -1;">
            <div class="empty-state">
              <i class="bi bi-exclamation-triangle"></i>
              <h3>เกิดข้อผิดพลาด</h3>
              <p>ไม่สามารถโหลดข้อมูลได้ กรุณาลองใหม่อีกครั้ง</p>
            </div>
          </div>
        `;
      }
    }

    function getBMIStatus(bmi) {
      if (bmi === 0) return '-';
      if (bmi < 18.5) return 'น้ำหนักน้อย';
      if (bmi < 23) return 'ปกติ';
      if (bmi < 25) return 'น้ำหนักเกิน';
      return 'โรคอ้วน';
    }

    async function loadChartData() {
  try {
    console.log("🚀 เริ่มโหลดข้อมูลกราฟ (Stats Page)...");
    
    const weightData = [];
    const calorieData = [];
    const labels = [];
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // เตรียม date range 7 วัน (รวมวันที่มีข้อมูล)
    const dateMap = {};
    const dateList = [];
    
    for (let i = 6; i >= 0; i--) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const isoDate = d.toISOString().split("T")[0];
      const label = d.toLocaleDateString("th-TH", { day: "numeric", month: "short" });
      
      dateList.push(isoDate);
      labels.push(label);
      dateMap[isoDate] = {
        weight: 0,
        calories: 0
      };
    }

    console.log("📅 Date Range:", dateList);

    // ดึงข้อมูล weight ปัจจุบัน
    const userDoc = await db.collection("users").doc(userId).get();
    const currentWeight = userDoc.exists && userDoc.data().weight ? userDoc.data().weight : 0;
    
    console.log("⚖️ น้ำหนักปัจจุบัน:", currentWeight, "กก.");

    // ดึงข้อมูลจาก logs
    const logsRef = db.collection("users").doc(userId).collection("logs");
    const logSnapshot = await logsRef.get();
    
    console.log("📚 จำนวน logs ทั้งหมด:", logSnapshot.size);

    // วนลูปทุก log document
    for (const logDoc of logSnapshot.docs) {
      const dateId = logDoc.id;
      
      console.log(`\n🔍 ตรวจสอบ: ${dateId}`);
      
      // เช็คว่าวันนี้อยู่ใน range หรือไม่
      if (dateMap.hasOwnProperty(dateId)) {
        console.log(`  ✅ ${dateId} อยู่ในช่วง 7 วัน`);
        
        const exerciseDetailsRef = logsRef.doc(dateId).collection("exercise_details");
        const exerciseSnapshot = await exerciseDetailsRef.get();
        
        console.log(`  📋 จำนวน exercise_details: ${exerciseSnapshot.size}`);

        let dayWeight = 0;
        let dayCalories = 0;

        exerciseSnapshot.forEach(exDoc => {
          const data = exDoc.data();
          
          console.log(`    📄 Doc: ${exDoc.id}`, data);
          
          // น้ำหนัก
          if (data.weight && data.weight > 0) {
            dayWeight = data.weight;
            console.log(`    ⚖️ น้ำหนัก: ${dayWeight} กก.`);
          }
          
          // แคลอรี่ - ลองหาจาก field ต่างๆ
          const foodCal = Number(data.foodCalories || data.foodcalories || 
                                 data.food_calories || data.calories || 
                                 data.calorie || 0);
          
          const exerciseCal = Number(data.exerciseCalories || data.exercisecalories || 
                                     data.exercise_calories || data.burnedCalories || 
                                     data.burned_calories || 0);
          
          console.log(`    🍴 Food: ${foodCal}, 🏃 Exercise: ${exerciseCal}`);
          
          dayCalories += foodCal + exerciseCal;
        });

        // บันทึกข้อมูล
        dateMap[dateId].weight = dayWeight;
        dateMap[dateId].calories = dayCalories;
        
        console.log(`  ✅ สรุป ${dateId}:`);
        console.log(`     น้ำหนัก: ${dayWeight} กก.`);
        console.log(`     แคลอรี่: ${dayCalories} แคล`);
      } else {
        console.log(`  ⏭️ ข้าม ${dateId} (นอกช่วง)`);
      }
    }

    console.log("\n📊 กำลังสร้างข้อมูลกราฟ...");

    // สร้าง arrays ตาม order ของ dateList
    let lastKnownWeight = currentWeight;
    
    for (const dateKey of dateList) {
      const data = dateMap[dateKey];
      
      // Weight: ใช้ค่าที่บันทึก หรือ carry forward
      if (data.weight > 0) {
        lastKnownWeight = data.weight;
      }
      weightData.push(lastKnownWeight);
      
      // Calories: ใช้ค่าที่มี
      calorieData.push(data.calories);
    }

    console.log("\n✅ ข้อมูลสุดท้าย:");
    console.log("📊 Weight Data:", weightData);
    console.log("📊 Calorie Data:", calorieData);
    console.log("📊 Labels:", labels);

    // แสดงกราฟ
    document.getElementById('weightChartSection').style.display = 'block';
    document.getElementById('calorieChartSection').style.display = 'block';

    createWeightChart(labels, weightData);
    createCalorieChart(labels, calorieData);

    console.log("✅ โหลดกราฟเสร็จสิ้น");

  } catch (error) {
    console.error("🔥 Error:", error);
    
    // แสดงกราฟว่างเมื่อเกิด error
    const labels = [];
    const emptyData = [];
    
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      labels.push(d.toLocaleDateString("th-TH", { day: "numeric", month: "short" }));
      emptyData.push(0);
    }
    
    document.getElementById('weightChartSection').style.display = 'block';
    document.getElementById('calorieChartSection').style.display = 'block';
    
    createWeightChart(labels, emptyData);
    createCalorieChart(labels, emptyData);
  }
}
    function createWeightChart(labels, data) {
      const ctx = document.getElementById('weightChart');
      
      if (weightChart) {
        weightChart.destroy();
      }
      
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'น้ำหนัก (กก.)',
            data: data,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, family: 'Kanit' },
              bodyFont: { size: 13, family: 'Kanit' },
              displayColors: false
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: { 
                font: { family: 'Kanit', size: 11 }
              },
              grid: { color: 'rgba(0, 0, 0, 0.05)' }
            },
            x: {
              ticks: { 
                font: { family: 'Kanit', size: 11 }
              },
              grid: { display: false }
            }
          }
        }
      });
    }

    function createCalorieChart(labels, data) {
      const ctx = document.getElementById('calorieChart');
      
      if (calorieChart) {
        calorieChart.destroy();
      }
      
      calorieChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'แคลอรี่ (แคล)',
            data: data,
            backgroundColor: 'rgba(118, 75, 162, 0.8)',
            borderColor: '#764ba2',
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: 'rgba(118, 75, 162, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 2.5,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, family: 'Kanit' },
              bodyFont: { size: 13, family: 'Kanit' },
              displayColors: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                font: { family: 'Kanit', size: 11 }
              },
              grid: { color: 'rgba(0, 0, 0, 0.05)' }
            },
            x: {
              ticks: { 
                font: { family: 'Kanit', size: 11 }
              },
              grid: { display: false }
            }
          }
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadUserStats();
    });
  </script>
</body>
</html>