<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - Belly Reset</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
  <script src="firebaseConfig.js"></script>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢ -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background: #f4f6f9;
      padding: 40px;
    }
    .container {
      max-width: 600px;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .profile-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
      border: 2px solid #ddd;
    }
    button {
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h3 class="text-center mb-4">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>

    <div class="text-center">
      <img id="preview-img" src="https://via.placeholder.com/120?text=No+Img" class="profile-img" alt="‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
      <input type="file" id="profileImage" class="form-control mt-2" accept="image/*">
    </div>

    <form id="edit-form" class="mt-4">
      <div class="mb-3">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
        <input type="text" id="name" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" id="email" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
        <div class="input-group">
          <input type="password" id="password" class="form-control" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)">
          <button type="button" class="btn btn-outline-secondary" id="togglePassword">
            <i class="bi bi-eye"></i>
          </button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">‡πÄ‡∏û‡∏®</label>
        <select id="gender" class="form-select">
          <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
          <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
          <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <input type="number" id="age" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
        <input type="number" id="height" class="form-control">
      </div>

      <div class="mb-3">
        <label class="form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
        <input type="number" id="weight" class="form-control">
      </div>

      <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <a href="manage_users.html" class="btn btn-secondary">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    </form>
  </div>

  <script>
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("id");

    const cloudName = "dxnxsyduc";   // ‚ö†Ô∏è Cloudinary cloud name
    const uploadPreset = "unsigned_preset"; // ‚ö†Ô∏è Cloudinary upload preset

    const nameInput = document.getElementById("name");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const genderInput = document.getElementById("gender");
    const ageInput = document.getElementById("age");
    const heightInput = document.getElementById("height");
    const weightInput = document.getElementById("weight");
    const profileImageInput = document.getElementById("profileImage");
    const previewImg = document.getElementById("preview-img");

    let currentImageUrl = null;

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    async function loadUser() {
      try {
        const doc = await db.collection("users").doc(userId).get();
        if (!doc.exists) {
          alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
          window.location.href = "manage_users.html";
          return;
        }

        const data = doc.data();
        nameInput.value = data.name || "";
        emailInput.value = data.email || "";
        genderInput.value = data.gender || "‡∏ä‡∏≤‡∏¢";
        ageInput.value = data.age || "";
        heightInput.value = data.height || "";
        weightInput.value = data.weight || "";
        currentImageUrl = data.profileImage || null;

        if (currentImageUrl) {
          previewImg.src = currentImageUrl;
        }
      } catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ Cloudinary
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      if (data.secure_url) return data.secure_url;
      throw new Error("Upload failed");
    }

    // Preview ‡∏£‡∏π‡∏õ
    profileImageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        previewImg.src = URL.createObjectURL(file);
      }
    });

    // toggle password visibility
    document.getElementById("togglePassword").addEventListener("click", () => {
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        document.getElementById("togglePassword").innerHTML = '<i class="bi bi-eye-slash"></i>';
      } else {
        passwordInput.type = "password";
        document.getElementById("togglePassword").innerHTML = '<i class="bi bi-eye"></i>';
      }
    });

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    document.getElementById("edit-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      let imageUrl = currentImageUrl;

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      if (profileImageInput.files.length > 0) {
        try {
          imageUrl = await uploadImage(profileImageInput.files[0]);
        } catch (err) {
          alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          console.error(err);
          return;
        }
      }

      try {
        const updateData = {
          name: nameInput.value,
          email: emailInput.value,
          gender: genderInput.value,
          age: parseInt(ageInput.value) || 0,
          height: parseFloat(heightInput.value) || 0,
          weight: parseFloat(weightInput.value) || 0,
          profileImage: imageUrl
        };

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏Å
        if (passwordInput.value.trim() !== "") {
          updateData.password = passwordInput.value.trim();
        }

        await db.collection("users").doc(userId).update(updateData);

        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        window.location.href = "manage_users.html";
      } catch (err) {
        console.error("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    });

    loadUser();
  </script>

</body>
</html>
